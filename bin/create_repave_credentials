#!/usr/bin/env bash

set -euo pipefail

: "${VAULT:=repave}"
: "${REPAVE_DATE:=$(date "+%d-%m-%Y")}"

CREDENTIALS=""

main() {
  generate_credentials
  create_1pwd_item
}

generate_credentials() {
  CREDENTIALS="$(cat <<JSON
    {
      "notesPlain": "generated by $0",
      "sections": [
        {
          "name": "fields",
          "fields": [
            {
              "n": "hostname",
              "k": "string",
              "t": "hostname",
              "v": "$(generate_password 1)"
            },
            {
              "n": "password",
              "k": "concealed",
              "t": "password",
              "v": "$(generate_password 2)"
            },
            {
              "n": "disk encryption passphrase",
              "k": "concealed",
              "t": "disk encryption passphrase",
              "v": "$(generate_password)"
            }
          ]
        }
      ]
    }
JSON
)"
}

create_1pwd_item() {
  op create item \
    --vault "$VAULT" \
    --title "Repave $REPAVE_DATE" \
    "Secure Note" \
    "$(echo "$CREDENTIALS" | op encode)"
}

main

